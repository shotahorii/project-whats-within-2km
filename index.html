<!DOCTYPE HTML>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>What's within 2km</title>
	<!-- Font Awesome JS -->
	<script src="https://kit.fontawesome.com/77cdee0fcb.js" crossorigin="anonymous"></script>
  <!-- Leaflet CSS then JS-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
   integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
   crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
    integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
    crossorigin="">
  </script>
	<!-- Custom CSS -->
	<style>
	html, body, #mapid {height: 100%;}
	.info {
    padding: 6px 8px; font: 14px/16px Arial,Helvetica,sans-serif; background: white;
    background: rgba(255,255,255,0.8); box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px;
	}
	.info h3 {
	    margin: 0px; margin-top: 2px; margin-right: 10px; margin-bottom: 2px; color: #777;
	}
	.info h5 {
	    margin: 0px; margin-top: 2px; margin-bottom: 5px; color: #777;
	}
</style>
</head>

<body>
	<div id="mapid" ng-app="myApp" ng-controller="myCtrl"></div>
</body>

<!-- Angular JS & Underscore JS-->
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>

<script type="text/javascript" src="data.js"></script>
<script type="text/javascript">
  const app = angular.module('myApp', []);
  app.controller('myCtrl', function($scope) {
		/* init map */
    const mymap = L.map('mapid').setView([53.3430402,-6.2566447], 13);
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
								maxZoom: 19,
								attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
							}).addTo(mymap);

		/* init marker layers */
		let layers = _.map(Object.keys(data),function(key){
			return {
				'key':key,
				'layer':L.layerGroup(_.map(data[key], function(e){ return L.marker([e[0], e[1]],{icon:e[2]}).bindPopup(e[3]);}))
			};
		});
		layers = Object.assign({}, ...layers.map((e) => ({[e.key]: e.layer})));
		Object.keys(layers).forEach(key => layers[key].addTo(mymap));
		L.control.layers({},layers).addTo(mymap);

		/* init status */
		initAllStatus();

		/* functions for status control */
		function initAllStatus(){
			$scope.is_centre_defined = false;
			$scope.circle = undefined, $scope.centre = undefined;
			$scope.within2km = _.map(Object.keys(data),key => [key,0]); /* e.g. [['Tesco',0],['Spar',0],['Centra',0],['Boots',0]]; */
		};
		function removeCircle(){
			mymap.removeLayer($scope.circle);
			mymap.removeLayer($scope.centre);
			initAllStatus();
		};
		function addCircle(e){
			$scope.circle = L.circle([e.latlng.lat, e.latlng.lng], {
					weight: 0, fillColor: 'grey', fillOpacity: 0.2, radius: 2000
			}).addTo(mymap);
			$scope.centre = L.marker([e.latlng.lat, e.latlng.lng]).addTo(mymap);
			$scope.is_centre_defined = true;
		};
		function calcWithin2km(e){
			$scope.within2km = _.map(Object.keys(data),key => [key,_count_within2km(e.latlng.lat, e.latlng.lng,data[key])])
		};

		/* Helper functions for distance calc - https://www.movable-type.co.uk/scripts/latlong.html */
		const _degree2radian = (degree) => degree*(Math.PI/180);
		function _get_distance(lat1,lng1,lat2,lng2){
			let lat1_r = _degree2radian(lat1), lat2_r = _degree2radian(lat2);
			let delta_lat = _degree2radian(lat2-lat1), delta_lng = _degree2radian(lng2-lng1);
			let a = Math.sin(delta_lat/2) * Math.sin(delta_lat/2) +
							Math.cos(lat1_r) * Math.cos(lat2_r) * Math.sin(delta_lng/2) * Math.sin(delta_lng/2);
			let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
			return 6371000 * c;
		};
		function _count_within2km(c_lat,c_lng,latlng_list){
			return _.map(latlng_list, function(latlng){
				return _get_distance(latlng[0],latlng[1],c_lat,c_lng)<=2000?1:0;
			}).reduce((s, f) => s + f, 0);
		};

		/* define info box on bottom left */
		const info = L.control({position: 'bottomleft'});
		info.onAdd = function (map) {
		    this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
		    this.update();
		    return this._div;
		};
		info.update = function () {
		    this._div.innerHTML = "<h3>What's within 2km?</h3> <h5>Click on the map to see</h5>"
					+ _.map($scope.within2km,function(e){return '<p>'+e[0]+':'+e[1].toString()+'</p>'}).reduce((s, f) => s + f, '');
		};
		info.addTo(mymap);

		/* click event */
    mymap.on('click', function(e) {
      if($scope.is_centre_defined){
        removeCircle();
				info.update();
      } else {
				addCircle(e);
				calcWithin2km(e);
				info.update();
      }
    });

  });
</script>
</html>
